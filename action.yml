name: 'linuxdeploy Build Helper'
description: 'An action that aims to help build an AppImage using linuxdeploy'

inputs:
  platform:
    description: 'Target platform for LinuxDeploy'
    required: true
    default: 'amd64'
  dependency_commands:
    description: 'Commands to install dependencies'
    required: false
    default: ''
  build_commands:
    description: 'Commands to build the project'
    required: true
    default: ''
  install_to_appdir_commands:
    description: 'Commands to install and copy files to the destination AppDir'
    required: true
    default: ''
  linuxdeploy_output_version:
    description: 'Version string used by linuxdeploy used for the image filename'
    required: true
    default: ''
  linuxdeploy_args:
    description: 'Argument string to pass to linuxdeploy'
    required: true
    default: ''

runs:
  using: 'composite'
  steps:
    - if: ${{ inputs.platform != 'amd64' }}
      uses: docker/setup-qemu-action@v3

    - name: Set ACTION_WORKSPACE
      shell: bash
      run: echo "ACTION_WORKSPACE=/workspace" >> $GITHUB_ENV

    - name: Set APPDIR
      shell: bash
      run: echo "APPDIR=$ACTION_WORKSPACE/AppDir" >> $GITHUB_ENV

    - name: Run LinuxDeploy
      id: linuxdeploy
      shell: bash
      run: |
        case ${{ inputs.platform }} in
          'amd64')
            ;;
          'arm64')
            ;;
          'arm/v7')
            ;;
          *)
            echo "Unsupported platform: ${{ inputs.platform }}"
            exit 1
            ;;
        esac
        export HOSTUID=$(id -u)
        docker run \
          -e HOSTUID -e APPDIR -e ACTION_WORKSPACE \
          --rm -v $(pwd):$ACTION_WORKSPACE \
          --platform linux/${{ inputs.platform }} -u root andy5995/linuxdeploy:latest \
          /bin/bash -c "usermod -u $HOSTUID builder && su builder -l -c 'export -p && \
          set -e && \
          cd $ACTION_WORKSPACE && \
          if [ -n \"${{ inputs.dependency_commands }}\" ]; then \
            eval \"${{ inputs.dependency_commands }}\"; \
          fi && \
          if [ -n \"${{ inputs.build_commands }}\" ]; then \
            eval \"${{ inputs.build_commands }}\"; \
          fi && \
          if [ -n \"${{ inputs.install_to_appdir_commands }}\" ]; then \
            eval \"${{ inputs.install_to_appdir_commands }}\"; \
          fi && \
          export LINUXDEPLOY_OUTPUT_VERSION=${{ inputs.linuxdeploy_output_version }} && \
          cd $ACTION_WORKSPACE && \
          linuxdeploy --appdir=$APPDIR ${{ inputs.linuxdeploy_args }}
          mkdir out && \
          mv *AppImage out'"

    - name: Set filename
      shell: bash
      run: |
        echo "IMAGE_FILENAME=$(basename `find out/*.AppImage`)" >> $GITHUB_ENV

branding:
  icon: package
  color: gray-dark
